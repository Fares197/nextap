<% layout("layout") %>

<div class="header">
    <h1>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø§Øª</h1>
    <div class="buttons">
        <a href="/export/returns" class="btn-success">ğŸ“¥ ØªØµØ¯ÙŠØ± CSV</a>
        <button class="btn-primary" onclick="printPDF()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
</div>

<div class="form-section">
    <h3>âœš Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø§Ø¯Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</h3>
    <form action="/returns/add" method="POST">
        <div class="form-group">
            <div>
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                <input type="text" name="product" required>
            </div>
            <div>
                <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                <input type="number" name="quantity" required>
            </div>
            <div>
                <label>Ø§Ù„Ø³Ø¨Ø¨</label>
                <input type="text" name="reason" required>
            </div>
            <div>
                <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input type="date" name="date" required>
            </div>
        </div>
        <button type="submit" class="btn-primary">âœš Ø¥Ø¶Ø§ÙØ©</button>
    </form>
</div>

<div class="search-filter">
    <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø£Ùˆ Ø³Ø¨Ø¨..." onkeyup="filterTable()">
</div>

<% if (returns.length > 0) { %>
    <table id="returnsTable">
        <thead>
            <tr>
                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody>
            <% returns.forEach(r => { %>
                <tr data-id="<%= r.id %>">
                    <td><input type="text" class="editable" data-field="product" value="<%= r.product %>"></td>
                    <td><input type="number" class="editable" data-field="quantity" value="<%= r.quantity %>"></td>
                    <td><input type="text" class="editable" data-field="reason" value="<%= r.reason %>"></td>
                    <td><input type="date" class="editable" data-field="date" value="<%= r.date %>"></td>
                    <td>
                        <select class="editable" data-field="status">
                            <option value="<%= r.status %>" selected><%= r.status %></option>
                            <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                            <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
                            <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
                        </select>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-danger" onclick="deleteReturn(<%= r.id %>)">Ø­Ø°Ù</button>
                        </div>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
<% } else { %>
    <div class="empty-message">
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø§Ø¯Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
        <p style="font-size: 12px; margin-top: 10px;">Ø£Ø¶Ù Ø¥Ø¹Ø§Ø¯Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡</p>
    </div>
<% } %>

<script>
    function deleteReturn(id) {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ")) {
            fetch("/returns/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id })
            }).then(() => location.reload());
        }
    }

    function printPDF() {
        const table = document.getElementById("returnsTable");
        if (!table) {
            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©");
            return;
        }
        const printWindow = window.open("", "", "height=600,width=800");
        printWindow.document.write("<html><head><title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø§Øª</title>");
        printWindow.document.write("<style>body { font-family: Arial; direction: rtl; padding: 20px; } .header { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 15px; } .logo { width: 60px; height: 60px; margin-left: 15px; } h2 { text-align: center; color: #2c3e50; margin: 0; } table { width: 100%; border-collapse: collapse; margin-top: 20px; } th { background: #3498db; color: white; padding: 10px; text-align: right; } td { padding: 10px; border-bottom: 1px solid #ddd; text-align: right; } .footer { text-align: center; margin-top: 20px; color: #7f8c8d; font-size: 12px; }</style>");
        printWindow.document.write("</head><body>");
        printWindow.document.write("<div class=\"header\"><img src=\"/assets/logo.png\" alt=\"Logo\" class=\"logo\"><h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø§Øª - Nextap</h2></div>");
        printWindow.document.write("<p style=\"text-align: center; color: #555;\">Ø§Ù„ØªØ§Ø±ÙŠØ®: " + new Date().toLocaleDateString("ar-SA") + "</p>");
        printWindow.document.write(table.outerHTML);
        printWindow.document.write("<div class=\"footer\"><p>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§</p></div>");
        printWindow.document.close();
        printWindow.print();
    }

    function filterTable() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const table = document.getElementById("returnsTable");
        if (!table) return;
        const rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
        for (let row of rows) {
            const product = row.querySelector("input[data-field=\"product\"]").value.toLowerCase();
            const reason = row.querySelector("input[data-field=\"reason\"]").value.toLowerCase();
            row.style.display = (product.includes(input) || reason.includes(input)) ? "" : "none";
        }
    }

    document.querySelectorAll(".editable").forEach(input => {
        input.addEventListener("change", function() {
            const row = this.closest("tr");
            const id = row.dataset.id;
            const field = this.dataset.field;
            const value = this.value;

            fetch("/returns/update-status", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id, field, value })
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    console.log("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­");
                }
            });
        });
    });
</script>
