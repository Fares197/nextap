<% layout("layout") %>

<div class="header">
    <h1>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… (Filament)</h1>
    <div class="buttons">
        <a href="/export/filament" class="btn-success">ğŸ“¥ ØªØµØ¯ÙŠØ± CSV</a>
        <button class="btn-primary" onclick="printPDF()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
</div>

<div class="form-section">
    <h3>âœš Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… Ø¬Ø¯ÙŠØ¯Ø©</h3>
    <form action="/filament/add" method="POST">
        <div class="form-group">
            <div>
                <label>Ø§Ù„Ù„ÙˆÙ†</label>
                <input type="text" name="color" required>
            </div>
            <div>
                <label>Ø§Ù„ÙˆØ²Ù† (Ø¬Ø±Ø§Ù…)</label>
                <input type="number" name="weight" required>
            </div>
            <div>
                <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                <input type="text" name="material" required>
            </div>
            <div>
                <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                <input type="number" name="quantity" required>
            </div>
            <div>
                <label>Ø§Ù„Ø³Ø¹Ø±</label>
                <input type="number" name="price" step="0.01" required>
            </div>
            <div>
                <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input type="date" name="date" required>
            </div>
        </div>
        <button type="submit" class="btn-primary">âœš Ø¥Ø¶Ø§ÙØ©</button>
    </form>
</div>

<div class="search-filter">
    <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø© Ø®Ø§Ù…..." onkeyup="filterTable()">
</div>

<% if (filament.length > 0) { %>
    <table id="filamentTable">
        <thead>
            <tr>
                <th>Ø§Ù„Ù„ÙˆÙ†</th>
                <th>Ø§Ù„ÙˆØ²Ù†</th>
                <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody>
            <% filament.forEach(f => { %>
                <tr data-id="<%= f.id %>">
                    <td><input type="text" class="editable" data-field="color" value="<%= f.color %>"></td>
                    <td><input type="number" class="editable" data-field="weight" value="<%= f.weight %>"></td>
                    <td><input type="text" class="editable" data-field="material" value="<%= f.material %>"></td>
                    <td><input type="number" class="editable" data-field="quantity" value="<%= f.quantity %>"></td>
                    <td><input type="number" class="editable" data-field="price" step="0.01" value="<%= f.price %>"></td>
                    <td><input type="date" class="editable" data-field="date" value="<%= f.date %>"></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-danger" onclick="deleteRow(<%= f.id %>, 
'/filament/delete')">Ø­Ø°Ù</button>
                        </div>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
<% } else { %>
    <div class="empty-message">
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
        <p style="font-size: 12px; margin-top: 10px;">Ø£Ø¶Ù Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡</p>
    </div>
<% } %>

<script>


    function printPDF() {
        const table = document.getElementById("filamentTable");
        if (!table) {
            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©");
            return;
        }
        const printWindow = window.open("", "", "height=600,width=800");
        printWindow.document.write("<html><head><title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</title>");
        printWindow.document.write("<style>body { font-family: Arial; direction: rtl; padding: 20px; } .header { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 15px; } .logo { width: 60px; height: 60px; margin-left: 15px; } h2 { text-align: center; color: #2c3e50; margin: 0; } table { width: 100%; border-collapse: collapse; margin-top: 20px; } th { background: #3498db; color: white; padding: 10px; text-align: right; } td { padding: 10px; border-bottom: 1px solid #ddd; text-align: right; } .footer { text-align: center; margin-top: 20px; color: #7f8c8d; font-size: 12px; }</style>");
        printWindow.document.write("</head><body>");
        printWindow.document.write("<div class=\"header\"><img src=\"/assets/logo.png\" alt=\"Logo\" class=\"logo\"><h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… - Nextap</h2></div>");
        printWindow.document.write("<p style=\"text-align: center; color: #555;\">Ø§Ù„ØªØ§Ø±ÙŠØ®: " + new Date().toLocaleDateString("ar-SA") + "</p>");
        printWindow.document.write(table.outerHTML);
        printWindow.document.write("<div class=\"footer\"><p>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§</p></div>");
        printWindow.document.close();
        printWindow.print();
    }

    function filterTable() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const table = document.getElementById("filamentTable");
        if (!table) return;
        const rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
        for (let row of rows) {
            const color = row.querySelector("input[data-field=\"color\"]").value.toLowerCase();
            const material = row.querySelector("input[data-field=\"material\"]").value.toLowerCase();
            row.style.display = (color.includes(input) || material.includes(input)) ? "" : "none";
        }
    }

    document.querySelectorAll(".editable").forEach(input => {
        input.addEventListener("change", function() {
            const row = this.closest("tr");
            const id = row.dataset.id;
            const field = this.dataset.field;
            const value = this.value;

            fetch("/filament/update", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id, field, value })
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    console.log("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­");
                }
            });
        });
    });
</script>
