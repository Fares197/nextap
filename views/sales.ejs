<% layout("layout") %>

<div class="header">
    <h1>ูุงุฆูุฉ ุงููุจูุนุงุช</h1>
    <div class="buttons">
        <a href="/export/sales" class="btn-success">๐ฅ ุชุตุฏูุฑ CSV</a>
        <button class="btn-primary" onclick="printPDF()">๐จ๏ธ ุทุจุงุนุฉ</button>
    </div>
</div>

<div class="form-section">
    <h3>โ ุฅุถุงูุฉ ูุจูุนุงุช ุฌุฏูุฏุฉ</h3>
    <form action="/sales/add" method="POST">
        <div class="form-group">
            <div>
                <label>ุงุณู ุงูููุชุฌ</label>
                <input type="text" name="product" required>
            </div>
            <div>
                <label>ุงููููุฉ</label>
                <input type="number" name="quantity" required>
            </div>
            <div>
                <label>ุงูุณุนุฑ</label>
                <input type="number" name="price" step="0.01" required>
            </div>
            <div>
                <label>ุงุณู ุงูุนููู</label>
                <input type="text" name="customerName" required>
            </div>
            <div>
                <label>ุฑูู ุงูุนููู</label>
                <input type="text" name="customerPhone" required>
            </div>
            <div>
                <label>ุทุฑููุฉ ุงูุฏูุน</label>
                <select name="paymentMethod" required>
                    <option value="">ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน</option>
                    <option value="ููุฏ">ููุฏ</option>
                    <option value="ุดูู">ุดูู</option>
                    <option value="ุชุญููู ุจููู">ุชุญููู ุจููู</option>
                    <option value="ุจุทุงูุฉ ุงุฆุชูุงู">ุจุทุงูุฉ ุงุฆุชูุงู</option>
                </select>
            </div>
            <div>
                <label>ุงูุชุงุฑูุฎ</label>
                <input type="date" name="date" required>
            </div>
        </div>
        <button type="submit" class="btn-primary">โ ุฅุถุงูุฉ</button>
    </form>
</div>

<div class="search-filter">
    <input type="text" id="searchInput" placeholder="๐ ุงุจุญุซ ุนู ููุชุฌ ุฃู ุนููู..." onkeyup="filterTable()">
</div>

<% if (sales.length > 0) { %>
    <table id="salesTable">
        <thead>
            <tr>
                <th>ุงูููุชุฌ</th>
                <th>ุงููููุฉ</th>
                <th>ุงูุณุนุฑ</th>
                <th>ุงูุฅุฌูุงูู</th>
                <th>ุงุณู ุงูุนููู</th>
                <th>ุฑูู ุงูุนููู</th>
                <th>ุทุฑููุฉ ุงูุฏูุน</th>
                <th>ุงูุชุงุฑูุฎ</th>
                <th>ุงูุฅุฌุฑุงุกุงุช</th>
            </tr>
        </thead>
        <tbody>
            <% sales.forEach(s => { %>
                <tr data-id="<%= s.id %>">
                    <td><input type="text" class="editable" data-field="product" value="<%= s.product %>"></td>
                    <td><input type="number" class="editable" data-field="quantity" value="<%= s.quantity %>"></td>
                    <td><input type="number" class="editable" data-field="price" step="0.01" value="<%= s.price %>"></td>
                    <td><strong>JOD <%= (s.quantity * s.price).toFixed(2) %></strong></td>
                    <td><input type="text" class="editable" data-field="customerName" value="<%= s.customerName %>"></td>
                    <td><input type="text" class="editable" data-field="customerPhone" value="<%= s.customerPhone %>"></td>
                    <td>
                        <select class="editable" data-field="paymentMethod">
                            <option value="<%= s.paymentMethod %>" selected><%= s.paymentMethod %></option>
                            <option value="ููุฏ">ููุฏ</option>
                            <option value="ุดูู">ุดูู</option>
                            <option value="ุชุญููู ุจููู">ุชุญููู ุจููู</option>
                            <option value="ุจุทุงูุฉ ุงุฆุชูุงู">ุจุทุงูุฉ ุงุฆุชูุงู</option>
                        </select>
                    </td>
                    <td><input type="date" class="editable" data-field="date" value="<%= s.date %>"></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-danger" onclick="deleteRow(<%= s.id %>, '/sales/delete')">ุญุฐู</button>
                        </div>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
<% } else { %>
    <div class="empty-message">
        <p>ูุง ุชูุฌุฏ ูุจูุนุงุช ุญุชู ุงูุขู</p>
        <p style="font-size: 12px; margin-top: 10px;">ุฃุถู ูุจูุนุงุช ุฌุฏูุฏุฉ ุจุงุณุชุฎุฏุงู ุงููููุฐุฌ ุฃุนูุงู</p>
    </div>
<% } %>

<script>


    function printPDF() {
        const table = document.getElementById("salesTable");
        if (!table) {
            alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ููุทุจุงุนุฉ");
            return;
        }
        const printWindow = window.open("", "", "height=600,width=800");
        printWindow.document.write("<html><head><title>ูุงุชูุฑุฉ ุงููุจูุนุงุช</title>");
        printWindow.document.write("<style>body { font-family: Arial; direction: rtl; padding: 20px; } .header { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; border-bottom: 2px solid #2ecc71; padding-bottom: 15px; } .logo { width: 60px; height: 60px; margin-left: 15px; } h2 { text-align: center; color: #2c3e50; margin: 0; } table { width: 100%; border-collapse: collapse; margin-top: 20px; } th { background: #2ecc71; color: white; padding: 10px; text-align: right; } td { padding: 10px; border-bottom: 1px solid #ddd; text-align: right; } .footer { text-align: center; margin-top: 20px; color: #7f8c8d; font-size: 12px; }</style>");
        printWindow.document.write("</head><body>");
        printWindow.document.write("<div class=\"header\"><img src=\"/assets/logo.png\" alt=\"Logo\" class=\"logo\"><h2>ูุงุชูุฑุฉ ุงููุจูุนุงุช - Nextap (JOD)</h2></div>");
        printWindow.document.write("<p style=\"text-align: center; color: #555;\">ุงูุชุงุฑูุฎ: " + new Date().toLocaleDateString("ar-SA") + "</p>");
        printWindow.document.write("<p style=\"text-align: center; color: #555;\">ุงูุนููุฉ: JOD</p>");
        printWindow.document.write(table.outerHTML);
        printWindow.document.write("<div class=\"footer\"><p>ุดูุฑุงู ูุชุนุงูููู ูุนูุง</p></div>");
        printWindow.document.write("</body></html>");
        printWindow.document.close();
        printWindow.print();
    }

    function filterTable() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const table = document.getElementById("salesTable");
        if (!table) return;
        const rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
        for (let row of rows) {
            const product = row.querySelector("input[data-field=\"product\"]").value.toLowerCase();
            const customerName = row.querySelector("input[data-field=\"customerName\"]").value.toLowerCase();
            row.style.display = (product.includes(input) || customerName.includes(input)) ? "" : "none";
        }
    }

    document.querySelectorAll(".editable").forEach(input => {
        input.addEventListener("change", function() {
            const row = this.closest("tr");
            const id = row.dataset.id;
            const field = this.dataset.field;
            const value = this.value;

            fetch("/sales/update", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id, field, value })
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    console.log("ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ");
                }
            });
        });
    });
</script>
